# Launch4jのHEADのカスタマイズ

## 概要

Launch4jのgui用headをカスタマイズして、以下のような挙動にする。

- --l4j-debug の指定がある場合は、コンソール画面も開く
- \*.l4j.iniファイルがない場合は、 \*.ini ファイルを使用する。
- Launch4jの生成時に指定した埋め込みの起動オプション引数(args)も変数展開する
  - ユーザーが起動時に指定できる追加の引数は変数展開はしない。
- 環境変数 %FIND_ANCESTOR:???% で %EXEDIR%上で???にマッチするファイルまたはディレクトリを検索して、マッチしたフルパスを返す。存在しない場合は更に親フォルダを検索する。発見できなければ空を返す。
- \*.cfgファィルにJAVA_HOMEを指定してある場合は、それが最優先される。
- \*.cfgファィルには ```Environments``` セクションに ```KEY=VALUE``` 形式で環境変数を指定できる。(環境変数は展開される)
- バンドルJRE、レジストリの探索も失敗した場合はユーザーにJAVA_HOMEの選択ダイアログを表示して選択してもらうことができる
  - JAVAが起動して即時(数秒以内)にエラーコードを返さなかった場合は、起動につかったJAVA\_HOMEは \*.cfg ファイルに有効なJAVA\_HOMEとして記録される
  - ただし、Settingsセクションに ```"SaveJavaHome=0"``` と指定されている場合は記録しない。


## ビルド方法

### Dev-C++ 5.0.2 (MinGW GCC 4.6.2 32Bit)の使用

元となるソースは、[Launch4j](http://launch4j.sourceforge.net/)のver3.12である。

Launch4j 3.12では、MinGWのbinutils 2.22を使用しており、このバージョンから、おそらく、gccは32ビット版の4.6.2あたりを使っていると思われる。


そのため、これに近いバージョンのコンパイル用として、[Dev-C++ 5.0.0.9](https://sourceforge.net/projects/orwelldevcpp/files/Portable%20Releases/) を使用している。

(完全には一致していないので、*.o, *.a は、Dev-C++ 5.0.0.9 でビルドに使ったものに置き換える必要がある。)

プロジェクトファイルは ```src/Launch4jStub/head_src/guihead/guihead.dev``` にあり、Dev-C++ で開くことができる。

(なお、```head.c``` ソースは、```consolehead``` のプロジェクトと共通である。)


### サンプルのビルド

このカスタマイズされたヘッダを使用した実行可能jarをexeファイル化するサンプルは maven でビルドできる。

```shell
mvn package
```

これで、targetディレクトリ上に このヘッダを使ったLaunch4jで生成された実行ファイル ```launch4jhead.exe``` が得られる。

このサンプルプログラムは、Swingで記述されたGUIアプリであり、システムプロパティと環境変数の一覧を表示する。

なお、一応、Java8, Java11のいずれで実行しても、HiDpi対応しており、スクリーンスケールにあわせて画面サイズを設定するようになっている。

END.

